---

- debug:
    msg: "{{ cert_dir }}"

- set_fact:
    group_name: "{{ cert_dir | basename }}"

- name: Upload cert
  fadcos_certificate_local:
    vdom: "{{ vdom }}"
    state: present
    path: "{{ item | dirname }}"
    name: "{{ (item | basename | splitext)[0] }}"
    host:  "{{ host }}"
    username: "{{ ansible_user }}"
    password: "{{ ansible_password }}"
  loop: "{{ lookup('fileglob', cert_dir  +  '/*.key', wantlist=True) }}"
  register: upload_cert_res
  failed_when: "upload_cert_res['meta']['output']['payload'] | int  not in [0, -15]"

- name: Cert in group
  fadcos_certificate_in_group:
    vdom: "{{ vdom }}"
    state: present
    certificate_name: "{{ (item | basename | splitext)[0] }}"
    group_name: "{{ group_name }}"
    host:  "{{ host }}"
    username: "{{ ansible_user }}"
    password: "{{ ansible_password }}"
  loop: "{{ lookup('fileglob', cert_dir  +  '/*.key', wantlist=True) }}"
  register: upload_cert_res
  failed_when: "upload_cert_res['meta']['output']['payload'] | int  not in [0, -15, -154]"

    # - name: delete cert
    #   fadcos_certificate_in_group:
    #     vdom: data
    #     state: absent
    #     certificate_name: "{{ (item | basename | splitext)[0] }}"
    #     group_name: GROUP_1
    #     host:  "{{ host }}"
    #     username: "{{ ansible_user }}"
    #     password: "{{ ansible_password }}"
    #   loop: "{{ lookup('fileglob', 'cert/*.key', wantlist=True) }}"

    # - name: Upload cert
    #   fadcos_local_certificate_group:
    #     vdom: data
    #     state: absent
    #     name: "{{ (item | basename | splitext)[0] }}"
    #     host:  "{{ host }}"
    #     username: "{{ ansible_user }}"
    #     password: "{{ ansible_password }}"
    #   loop: "{{ lookup('fileglob', 'cert/*.key', wantlist=True) }}"
    #   register: local_cert_group_res
